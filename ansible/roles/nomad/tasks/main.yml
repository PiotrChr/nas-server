---
- name: Add HashiCorp GPG
  apt_key:
    url: https://apt.releases.hashicorp.com/gpg
    state: present

- name: Add HashiCorp repo
  apt_repository:
    repo: "deb [arch=amd64] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
    state: present
    filename: hashicorp

- name: Install Nomad
  apt:
    name: nomad
    state: present
    update_cache: yes

- name: Allow Nomad UI from local network only
  ufw:
    rule: allow
    port: 4646
    proto: tcp
    src: 192.168.1.0/24

- name: Create Nomad config dir
  file:
    path: /etc/nomad.d
    state: directory
    mode: "0755"

- name: Ensure Nomad host volumes exist
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode | default('0755') }}"
    owner: "{{ item.owner | default(omit) }}"
    group: "{{ item.group | default(omit) }}"
    recurse: "{{ item.recurse | default(true) }}"
  loop: "{{ nomad_host_volumes }}"
  when: item.ensure | default(true)
  loop_control:
    label: "{{ item.name }}"

- name: Allow HTTP/HTTPS on LAN
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    src: 192.168.1.0/24
  loop:
    - "80"
    - "443"

- name: Ensure CNI directory exists
  file:
    path: /opt/cni/bin
    state: directory
    mode: "0755"

# Ubuntu/Debian: packaged plugins
- name: Install CNI plugins
  apt:
    name: containernetworking-plugins
    state: present
    update_cache: yes

- name: Symlink CNI plugins into /opt/cni/bin if present in /usr/lib/cni
  file:
    src: "/usr/lib/cni/{{ item }}"
    dest: "/opt/cni/bin/{{ item }}"
    state: link
  loop:
    - bridge
    - host-local
    - loopback
  when: ansible_facts['os_family'] == 'Debian'

- name: Deploy Nomad config with host volumes
  template:
    src: nomad.hcl.j2
    dest: /etc/nomad.d/nomad.hcl
    mode: "0644"
  notify: restart nomad

  
